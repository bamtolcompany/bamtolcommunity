<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<title>커뮤니티 앱</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Roboto&display=swap');
  body {
    max-width: 700px;
    margin: 30px auto;
    font-family: 'Roboto', sans-serif;
    background: #f4f6f8;
    color: #333;
  }
  h1 {
    text-align: center;
    margin-bottom: 30px;
    color: #222;
  }

  #auth, #app {
    background: white;
    border-radius: 10px;
    box-shadow: 0 4px 12px rgb(0 0 0 / 0.1);
    padding: 20px 25px;
    margin-bottom: 30px;
  }

  input, textarea {
    width: 100%;
    padding: 12px 15px;
    border-radius: 6px;
    border: 1px solid #ccc;
    margin-bottom: 15px;
    font-size: 14px;
    box-sizing: border-box;
    transition: border-color 0.3s;
  }
  input:focus, textarea:focus {
    border-color: #5b9ef8;
    outline: none;
  }

  button {
    background: #5b9ef8;
    color: white;
    border: none;
    padding: 12px 20px;
    border-radius: 6px;
    font-size: 16px;
    cursor: pointer;
    transition: background 0.25s;
  }
  button:hover {
    background: #477fdb;
  }
  button.secondary {
    background: #eee;
    color: #555;
  }
  button.secondary:hover {
    background: #ddd;
  }

  .post {
    background: white;
    border-radius: 10px;
    padding: 20px;
    margin-bottom: 20px;
    box-shadow: 0 2px 10px rgb(0 0 0 / 0.05);
  }

  .post-header {
    display: flex;
    align-items: center;
    margin-bottom: 12px;
  }

  .avatar {
    width: 40px;
    height: 40px;
    background: #5b9ef8;
    border-radius: 50%;
    color: white;
    font-weight: 700;
    font-size: 18px;
    display: flex;
    justify-content: center;
    align-items: center;
    margin-right: 12px;
    user-select: none;
  }

  .post-author {
    font-weight: 600;
    font-size: 16px;
  }
  .post-date {
    margin-left: auto;
    font-size: 13px;
    color: #777;
  }

  .post-content {
    white-space: pre-wrap;
    font-size: 15px;
    margin-bottom: 12px;
  }

  .post img {
    max-width: 100%;
    border-radius: 10px;
    margin-bottom: 12px;
  }

  .post-actions {
    display: flex;
    gap: 15px;
  }
  .post-actions button {
    background: none;
    border: none;
    cursor: pointer;
    color: #555;
    font-size: 14px;
    display: flex;
    align-items: center;
    gap: 5px;
    padding: 5px 8px;
    border-radius: 6px;
    transition: background 0.2s, color 0.2s;
  }
  .post-actions button:hover {
    background: #5b9ef8;
    color: white;
  }
  .post-actions button svg {
    width: 16px;
    height: 16px;
    fill: currentColor;
  }

  .comments {
    margin-top: 15px;
    border-top: 1px solid #eee;
    padding-top: 15px;
  }
  .comment {
    background: #f9fafc;
    border-radius: 8px;
    padding: 12px 15px;
    margin-bottom: 10px;
  }
  .comment b {
    font-weight: 600;
  }
  .comment-date {
    font-size: 11px;
    color: #888;
    margin-left: 6px;
  }

  .comment-input {
    margin-top: 10px;
    display: flex;
    gap: 10px;
  }
  .comment-input textarea {
    flex-grow: 1;
    resize: vertical;
    min-height: 40px;
    font-size: 14px;
  }
  .comment-input button {
    padding: 10px 15px;
  }

  /* Hide default file input and style label */
  #post-image {
    display: none;
  }
  label[for="post-image"] {
    display: inline-block;
    padding: 10px 15px;
    background: #eee;
    border-radius: 6px;
    cursor: pointer;
    margin-bottom: 15px;
    font-size: 14px;
    color: #555;
  }
  label[for="post-image"]:hover {
    background: #ddd;
  }
</style>
</head>
<body>

<h1>커뮤니티 앱</h1>

<div id="auth">
  <h3>회원가입</h3>
  <input id="reg-username" placeholder="사용자 이름" autocomplete="off" />
  <input id="reg-password" placeholder="비밀번호" type="password" autocomplete="off" />
  <button onclick="register()">회원가입</button>

  <hr style="margin: 25px 0;" />

  <h3>로그인</h3>
  <input id="login-username" placeholder="사용자 이름" autocomplete="off" />
  <input id="login-password" placeholder="비밀번호" type="password" autocomplete="off" />
  <button onclick="login()">로그인</button>
</div>

<div id="app" class="hidden">
  <button class="secondary" onclick="logout()">로그아웃</button>

  <h3>글쓰기</h3>
  <textarea id="post-content" placeholder="내용을 입력하세요..." rows="3"></textarea>
  <label for="post-image">이미지 첨부하기</label>
  <input type="file" id="post-image" accept="image/*" />
  <button onclick="writePost()">글 작성</button>

  <h3 style="margin-top:40px;">게시글 목록</h3>
  <div id="posts"></div>
</div>

<script>
let currentUser = null;

function showMessage(msg) {
  alert(msg);
}

function getInitials(name) {
  const parts = name.trim().split(' ');
  if (parts.length === 1) return parts[0][0].toUpperCase();
  return (parts[0][0] + parts[1][0]).toUpperCase();
}

function register() {
  fetch('/register', {
    method: 'POST',
    headers: {'Content-Type':'application/json'},
    body: JSON.stringify({
      username: document.getElementById('reg-username').value.trim(),
      password: document.getElementById('reg-password').value
    })
  }).then(res => res.json()).then(data => showMessage(data.message));
}

function login() {
  fetch('/login', {
    method: 'POST',
    headers: {'Content-Type':'application/json'},
    body: JSON.stringify({
      username: document.getElementById('login-username').value.trim(),
      password: document.getElementById('login-password').value
    })
  }).then(res => {
    if(res.status === 200) return res.json();
    else throw new Error('로그인 실패');
  }).then(data => {
    currentUser = { id: data.user_id, username: document.getElementById('login-username').value.trim() };
    document.getElementById('auth').classList.add('hidden');
    document.getElementById('app').classList.remove('hidden');
    loadPosts();
  }).catch(e => alert(e.message));
}

function logout() {
  currentUser = null;
  document.getElementById('auth').classList.remove('hidden');
  document.getElementById('app').classList.add('hidden');
}

function loadPosts() {
  fetch('/posts').then(res => res.json()).then(posts => {
    const postsDiv = document.getElementById('posts');
    postsDiv.innerHTML = '';
    posts.forEach(post => {
      const postDiv = document.createElement('div');
      postDiv.className = 'post';

      const initials = getInitials(post.author);

      postDiv.innerHTML = `
        <div class="post-header">
          <div class="avatar">${initials}</div>
          <div class="post-author">${post.author}</div>
          <div class="post-date">${new Date(post.created).toLocaleString()}</div>
        </div>
        <div class="post-content">${post.content.replace(/\n/g, '<br>')}</div>
        ${post.image ? `<img src="/uploads/${post.image}" alt="post image" />` : ''}
        <div class="post-actions">
          <button onclick="toggleLike(${post.id})">
            <svg viewBox="0 0 24 24"><path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3
            7.5 3c1.74 0 3.41 0.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22
            8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/></svg>
            좋아요 (${post.likes})
          </button>
          <button onclick="toggleComments(${post.id})">
            <svg viewBox="0 0 24 24"><path d="M20 17.17V5c0-1.1-.9-2-2-2H6c-1.1 0-2 .9-2
            2v12.17l4-4 4 4 4-4 4 4z"/></svg>
            댓글 보기
          </button>
          <button onclick="reportPost(${post.id})">
            <svg viewBox="0 0 24 24"><path d="M1 21h22L12 2 1 21zM12
            16v-4M12 20h.01"/></svg>
            신고
          </button>
        </div>
        <div class="comments hidden" id="comments-${post.id}">
          <div class="comments-list"></div>
          <div class="comment-input">
            <textarea id="comment-text-${post.id}" placeholder="댓글 입력..."></textarea>
            <button onclick="writeComment(${post.id})">작성</button>
          </div>
        </div>
      `;

      postsDiv.appendChild(postDiv);
    });
  });
}

function writePost() {
  if (!currentUser) return alert('로그인 먼저 해주세요');
  const content = document.getElementById('post-content').value.trim();
  if(!content) return alert('내용을 입력하세요.');
  const imageFile = document.getElementById('post-image').files[0];

  const formData = new FormData();
  formData.append('user_id', currentUser.id);
  formData.append('content', content);
  if (imageFile) formData.append('image', imageFile);

  fetch('/posts', { method: 'POST', body: formData })
    .then(res => res.json())
    .then(data => {
      showMessage(data.message);
      document.getElementById('post-content').value = '';
      document.getElementById('post-image').value = '';
      loadPosts();
    });
}

function toggleLike(postId) {
  if (!currentUser) return alert('로그인 먼저 해주세요');
  fetch(`/posts/${postId}/like`, {
    method: 'POST',
    headers: {'Content-Type':'application/json'},
    body: JSON.stringify({user_id: currentUser.id})
  }).then(res => res.json())
    .then(data => {
      showMessage(data.message);
      loadPosts();
    });
}

function toggleComments(postId) {
  const commentsDiv = document.getElementById(`comments-${postId}`);
  if (commentsDiv.classList.contains('hidden')) {
    fetch(`/comments/${postId}`)
      .then(res => res.json())
      .then(comments => {
        const commentsList = commentsDiv.querySelector('.comments-list');
        commentsList.innerHTML = '';
        comments.forEach(c => {
          const cDiv = document.createElement('div');
          cDiv.className = 'comment';
          cDiv.innerHTML = `<b>${c.author}</b><span class="comment-date"> - ${new Date(c.created).toLocaleString()}</span><br>${c.text.replace(/\n/g,'<br>')}`;
          commentsList.appendChild(cDiv);
        });
        commentsDiv.classList.remove('hidden');
      });
  } else {
    commentsDiv.classList.add('hidden');
  }
}

function writeComment(postId) {
  if (!currentUser) return alert('로그인 먼저 해주세요');
  const textArea = document.getElementById(`comment-text-${postId}`);
  const text = textArea.value.trim();
  if (!text) return alert('댓글 내용을 입력하세요');

  fetch(`/comments/${postId}`, {
    method: 'POST',
    headers: {'Content-Type':'application/json'},
    body: JSON.stringify({user_id: currentUser.id, text: text})
  }).then(res => res.json())
    .then(data => {
      showMessage(data.message);
      textArea.value = '';
      toggleComments(postId); // 한번 숨기고
      toggleComments(postId); // 다시 보여줘서 댓글 새로고침
    });
}

function reportPost(postId) {
  if (!currentUser) return alert('로그인 먼저 해주세요');
  const reason = prompt('신고 사유를 입력하세요');
  if (!reason) return;

  fetch(`/posts/${postId}/report`, {
    method: 'POST',
    headers: {'Content-Type':'application/json'},
    body: JSON.stringify({user_id: currentUser.id, reason: reason})
  }).then(res => res.json())
    .then(data => showMessage(data.message));
}
</script>

</body>
</html>
