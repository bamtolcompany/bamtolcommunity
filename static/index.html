<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>밤톨 커뮤니티</title>
<style>
  /* 심플하고 꽉찬 레이아웃 */
  body, html { margin:0; padding:0; height:100%; font-family: 'Noto Sans KR', sans-serif; }
  .container { max-width: 900px; margin: auto; padding: 20px; box-sizing: border-box; }
  h1 { margin-bottom: 20px; }
  ul { list-style:none; padding:0; }
  li { padding: 10px 0; border-bottom: 1px solid #eee; }
  a.post-link { color:#333; text-decoration:none; font-weight: 600; font-size: 18px; }
  a.post-link:hover { text-decoration: underline; }
  form { margin-bottom: 20px; }
  input, button, textarea { width: 100%; padding: 8px; margin: 6px 0; box-sizing: border-box; border: 1px solid #ccc; border-radius: 0; outline:none; }
  button { background: #333; color: white; cursor: pointer; }
  button:hover { background: #555; }
</style>
</head>
<body>
  <div class="container">
    <h1>밤톨 커뮤니티</h1>

    <!-- 글 작성 버튼 -->
    <button id="showWriteBtn">글 작성하기 +</button>

    <!-- 글 작성 폼 (숨김 처리) -->
    <form id="writeForm" style="display:none;" enctype="multipart/form-data">
      <input type="text" id="userIdInput" placeholder="유저ID 입력 (예: 1)" required />
      <input type="text" id="titleInput" placeholder="글 제목" required />
      <textarea id="contentInput" rows="5" placeholder="글 내용" required></textarea>
      <input type="file" id="imageInput" accept="image/*" />
      <button type="submit">작성 완료</button>
    </form>

    <ul id="postsList"><li>불러오는 중...</li></ul>
  </div>

<script>
  const postsList = document.getElementById("postsList");
  const writeForm = document.getElementById("writeForm");
  const showWriteBtn = document.getElementById("showWriteBtn");

  showWriteBtn.onclick = () => {
    writeForm.style.display = writeForm.style.display === "none" ? "block" : "none";
  };

  async function loadPosts() {
    postsList.innerHTML = "<li>불러오는 중...</li>";
    try {
      const res = await fetch("/posts");
      const posts = await res.json();
      if(Array.isArray(posts)) {
        if(posts.length === 0) {
          postsList.innerHTML = "<li>등록된 글이 없습니다.</li>";
          return;
        }
        postsList.innerHTML = "";
        posts.forEach(post => {
          // 글 제목은 content 첫 줄로 가정
          const title = post.content.split("\n")[0] || "(제목 없음)";
          const li = document.createElement("li");
          li.innerHTML = `<a class="post-link" href="post.html?post_id=${post.id}">${title}</a>`;
          postsList.appendChild(li);
        });
      }
    } catch(e) {
      postsList.innerHTML = "<li>글 불러오기 실패</li>";
    }
  }

  writeForm.onsubmit = async (e) => {
    e.preventDefault();
    const user_id = document.getElementById("userIdInput").value.trim();
    const title = document.getElementById("titleInput").value.trim();
    const content = document.getElementById("contentInput").value.trim();
    const imageInput = document.getElementById("imageInput");

    if(!user_id || !title || !content) {
      alert("모든 필드를 채워주세요.");
      return;
    }

    const fullContent = title + "\n" + content;

    const formData = new FormData();
    formData.append("user_id", user_id);
    formData.append("content", fullContent);
    if(imageInput.files.length > 0) {
      formData.append("image", imageInput.files[0]);
    }

    try {
      const res = await fetch("/posts", {
        method: "POST",
        body: formData
      });
      const data = await res.json();
      alert(data.message || "작성 완료");
      writeForm.reset();
      writeForm.style.display = "none";
      loadPosts();
    } catch {
      alert("글 작성 중 오류 발생");
    }
  };

  loadPosts();
</script>
</body>
</html>
