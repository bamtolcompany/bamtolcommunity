<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>커뮤니티 앱 - 새 UI</title>
<style>
  /* Reset & 기본 */
  * {
    box-sizing: border-box;
  }
  body {
    margin: 0; padding: 0;
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    background: #f5f7fa;
    color: #333;
    height: 100vh;
    display: flex;
    overflow: hidden;
  }

  /* 레이아웃: 좌측 사이드바, 중앙 게시글, 우측 글쓰기+댓글 */
  #sidebar {
    width: 280px;
    background: #1e293b;
    color: #e2e8f0;
    padding: 20px;
    display: flex;
    flex-direction: column;
    gap: 24px;
    overflow-y: auto;
  }
  #sidebar h2 {
    margin: 0 0 10px;
    font-weight: 700;
    font-size: 1.5rem;
  }
  #sidebar input, #sidebar button {
    width: 100%;
    padding: 10px 12px;
    margin-bottom: 12px;
    border-radius: 6px;
    border: none;
    font-size: 1rem;
  }
  #sidebar input {
    border: 1.5px solid #475569;
    background: #334155;
    color: #e2e8f0;
    transition: border-color 0.3s;
  }
  #sidebar input:focus {
    outline: none;
    border-color: #3b82f6;
    background: #1e293b;
  }
  #sidebar button {
    background: #3b82f6;
    color: white;
    font-weight: 600;
    cursor: pointer;
    border: none;
    transition: background-color 0.25s ease;
  }
  #sidebar button:hover {
    background: #2563eb;
  }

  #main {
    flex-grow: 1;
    display: flex;
    flex-direction: column;
    padding: 20px;
    overflow-y: auto;
  }

  #header {
    font-size: 2rem;
    font-weight: 700;
    margin-bottom: 20px;
    color: #1e293b;
  }

  #posts-list {
    flex-grow: 1;
    overflow-y: auto;
    display: grid;
    grid-template-columns: repeat(auto-fill,minmax(280px,1fr));
    gap: 18px;
  }

  .post-card {
    background: white;
    border-radius: 10px;
    box-shadow: 0 4px 10px rgb(0 0 0 / 0.05);
    padding: 16px;
    display: flex;
    flex-direction: column;
    transition: box-shadow 0.3s ease;
    cursor: pointer;
  }
  .post-card:hover {
    box-shadow: 0 8px 20px rgb(0 0 0 / 0.1);
  }
  .post-header {
    font-weight: 700;
    font-size: 1.1rem;
    color: #2563eb;
    margin-bottom: 6px;
  }
  .post-date {
    font-size: 0.8rem;
    color: #64748b;
    margin-bottom: 10px;
  }
  .post-content {
    flex-grow: 1;
    font-size: 1rem;
    line-height: 1.3;
    color: #334155;
    margin-bottom: 10px;
    white-space: pre-wrap;
    word-break: break-word;
  }
  .post-image {
    max-width: 100%;
    border-radius: 8px;
    margin-bottom: 10px;
    object-fit: cover;
    max-height: 160px;
  }
  .post-actions {
    display: flex;
    justify-content: space-between;
    gap: 8px;
  }
  .post-actions button {
    flex-grow: 1;
    padding: 8px 0;
    border: none;
    border-radius: 6px;
    background: #e0e7ff;
    color: #4338ca;
    font-weight: 600;
    cursor: pointer;
    transition: background-color 0.2s ease;
  }
  .post-actions button:hover {
    background: #c7d2fe;
  }

  #right-panel {
    width: 320px;
    background: white;
    border-left: 1.5px solid #e2e8f0;
    padding: 20px;
    display: flex;
    flex-direction: column;
    gap: 20px;
    overflow-y: auto;
  }

  #post-editor textarea {
    width: 100%;
    resize: vertical;
    min-height: 120px;
    padding: 12px;
    font-size: 1rem;
    border-radius: 8px;
    border: 1.5px solid #94a3b8;
    font-family: inherit;
  }
  #post-editor input[type="file"] {
    margin-top: 10px;
  }
  #post-editor button {
    margin-top: 12px;
    width: 100%;
    padding: 12px;
    font-weight: 700;
    font-size: 1rem;
    border: none;
    border-radius: 8px;
    background-color: #2563eb;
    color: white;
    cursor: pointer;
    transition: background-color 0.3s ease;
  }
  #post-editor button:hover {
    background-color: #1d4ed8;
  }

  #comments-section {
    flex-grow: 1;
    overflow-y: auto;
  }
  #comments-section h3 {
    margin: 0 0 10px;
    color: #334155;
  }
  .comment {
    background: #f1f5f9;
    padding: 12px 16px;
    border-radius: 10px;
    margin-bottom: 12px;
    font-size: 0.9rem;
    color: #475569;
  }
  .comment b {
    color: #1e293b;
    margin-bottom: 6px;
    display: block;
  }
  .comment-date {
    font-size: 0.75rem;
    color: #94a3b8;
    margin-bottom: 6px;
  }

  #comment-input {
    display: flex;
    flex-direction: column;
    gap: 8px;
  }
  #comment-input textarea {
    resize: vertical;
    min-height: 70px;
    padding: 10px;
    border-radius: 6px;
    border: 1.5px solid #94a3b8;
    font-family: inherit;
    font-size: 0.95rem;
  }
  #comment-input button {
    align-self: flex-end;
    background: #2563eb;
    color: white;
    font-weight: 700;
    border: none;
    border-radius: 6px;
    padding: 8px 16px;
    cursor: pointer;
    transition: background-color 0.3s ease;
  }
  #comment-input button:hover {
    background: #1d4ed8;
  }

  /* 모바일 대응 */
  @media (max-width: 900px) {
    body {
      flex-direction: column;
      height: auto;
    }
    #sidebar, #right-panel {
      width: 100%;
      height: auto;
      border-left: none;
      border-top: 1.5px solid #e2e8f0;
      padding: 12px 16px;
    }
    #main {
      padding: 12px 16px;
    }
    #posts-list {
      grid-template-columns: 1fr;
      gap: 14px;
    }
  }
</style>
</head>
<body>

<div id="sidebar">
  <h2>커뮤니티</h2>

  <div id="auth-section">
    <h3>회원가입</h3>
    <input id="reg-username" placeholder="사용자 이름" />
    <input id="reg-password" placeholder="비밀번호" type="password" />
    <button onclick="register()">회원가입</button>

    <hr style="border: 0.5px solid #475569; margin: 20px 0;" />

    <h3>로그인</h3>
    <input id="login-username" placeholder="사용자 이름" />
    <input id="login-password" placeholder="비밀번호" type="password" />
    <button onclick="login()">로그인</button>
  </div>

  <div id="user-info" class="hidden">
    <p>안녕하세요, <b id="user-name"></b>님!</p>
    <button onclick="logout()" style="background:#ef4444;">로그아웃</button>
  </div>
</div>

<div id="main">
  <div id="header">게시글 목록</div>
  <div id="posts-list">
    <!-- 게시글 카드가 여기에 동적으로 추가됨 -->
  </div>
</div>

<div id="right-panel" class="hidden">
  <div id="post-editor">
    <h3>글쓰기</h3>
    <textarea id="post-content" placeholder="내용을 입력하세요..."></textarea>
    <input type="file" id="post-image" accept="image/*" />
    <button onclick="writePost()">작성하기</button>
  </div>

  <div id="comments-section">
    <h3>댓글</h3>
    <div id="comments-list"></div>

    <div id="comment-input">
      <textarea id="comment-text" placeholder="댓글을 입력하세요..."></textarea>
      <button onclick="writeComment()">댓글 작성</button>
    </div>
  </div>
</div>

<script>
let currentUser = null;
let selectedPostId = null;

function showMessage(msg) {
  alert(msg);
}

function toggleAuthUI(isLoggedIn) {
  document.getElementById('auth-section').classList.toggle('hidden', isLoggedIn);
  document.getElementById('user-info').classList.toggle('hidden', !isLoggedIn);
  document.getElementById('right-panel').classList.toggle('hidden', !isLoggedIn);
  if (isLoggedIn) {
    document.getElementById('user-name').textContent = currentUser.username;
  } else {
    clearRightPanel();
  }
}

function clearRightPanel() {
  document.getElementById('post-content').value = '';
  document.getElementById('post-image').value = '';
  document.getElementById('comments-list').innerHTML = '';
  document.getElementById('comment-text').value = '';
  selectedPostId = null;
}

function register() {
  const username = document.getElementById('reg-username').value.trim();
  const password = document.getElementById('reg-password').value.trim();
  if (!username || !password) return showMessage('회원가입 정보를 입력하세요');

  fetch('/register', {
    method: 'POST',
    headers: {'Content-Type':'application/json'},
    body: JSON.stringify({username, password})
  }).then(res => res.json())
    .then(data => showMessage(data.message));
}

function login() {
  const username = document.getElementById('login-username').value.trim();
  const password = document.getElementById('login-password').value.trim();
  if (!username || !password) return showMessage('로그인 정보를 입력하세요');

  fetch('/login', {
    method: 'POST',
    headers: {'Content-Type':'application/json'},
    body: JSON.stringify({username, password})
  }).then(res => {
    if (res.status === 200) return res.json();
    else throw new Error('로그인 실패');
  }).then(data => {
    currentUser = { id: data.user_id, username };
    toggleAuthUI(true);
    loadPosts();
  }).catch(e => showMessage(e.message));
}

function logout() {
  currentUser = null;
  toggleAuthUI(false);
  clearRightPanel();
  document.getElementById('posts-list').innerHTML = '';
}

function loadPosts() {
  fetch('/posts').then(res => res.json()).then(posts => {
    const container = document.getElementById('posts-list');
    container.innerHTML = '';
    posts.forEach(post => {
      const postCard = document.createElement('div');
      postCard.className = 'post-card';
      postCard.innerHTML = `
        <div class="post-header">${post.author}</div>
        <div class="post-date">${new Date(post.created).toLocaleString()}</div>
        <div class="post-content">${post.content}</div>
        ${post.image ? `<img src="/uploads/${post.image}" class="post-image" alt="게시글 이미지" />` : ''}
        <div class="post-actions">
          <button onclick="toggleLike(event, ${post.id})">좋아요 (${post.likes})</button>
          <button onclick="selectPost(event, ${post.id})">댓글 보기</button>
          <button onclick="reportPost(event, ${post.id})" style="background:#f87171; color:white;">신고</button>
        </div>
      `;
      container.appendChild(postCard);
    });
  });
}

function selectPost(event, postId) {
  event.stopPropagation();
  selectedPostId = postId;
  loadComments(postId);
}

function loadComments(postId) {
  fetch(`/comments/${postId}`)
    .then(res => res.json())
    .then(comments => {
      const commentsList = document.getElementById('comments-list');
      commentsList.innerHTML = '';
      comments.forEach(c => {
        const cDiv = document.createElement('div');
        cDiv.className = 'comment';
        cDiv.innerHTML = `
          <b>${c.author}</b>
          <div class="comment-date">${new Date(c.created).toLocaleString()}</div>
          <div>${c.text}</div>
        `;
        commentsList.appendChild(cDiv);
      });
    });
}

function writePost() {
  if (!currentUser) return showMessage('로그인 먼저 해주세요');
  const content = document.getElementById('post-content').value.trim();
  if (!content) return showMessage('글 내용을 입력하세요');

  const imageFile = document.getElementById('post-image').files[0];
  const formData = new FormData();
  formData.append('user_id', currentUser.id);
  formData.append('content', content);
  if (imageFile) formData.append('image', imageFile);

  fetch('/posts', { method: 'POST', body: formData })
    .then(res => res.json())
    .then(data => {
      showMessage(data.message);
      document.getElementById('post-content').value = '';
      document.getElementById('post-image').value = '';
      loadPosts();
    });
}

function toggleLike(event, postId) {
  event.stopPropagation();
  if (!currentUser) return showMessage('로그인 먼저 해주세요');
  fetch(`/posts/${postId}/like`, {
    method: 'POST',
    headers: {'Content-Type':'application/json'},
    body: JSON.stringify({user_id: currentUser.id})
  }).then(res => res.json())
    .then(data => {
      showMessage(data.message);
      loadPosts();
    });
}

function writeComment() {
  if (!currentUser) return showMessage('로그인 먼저 해주세요');
  if (!selectedPostId) return showMessage('댓글을 작성할 게시글을 선택하세요');

  const text = document.getElementById('comment-text').value.trim();
  if (!text) return showMessage('댓글 내용을 입력하세요');

  fetch(`/comments/${selectedPostId}`, {
    method: 'POST',
    headers: {'Content-Type':'application/json'},
    body: JSON.stringify({user_id: currentUser.id, text})
  }).then(res => res.json())
    .then(data => {
      showMessage(data.message);
      document.getElementById('comment-text').value = '';
      loadComments(selectedPostId);
    });
}

function reportPost(event, postId) {
  event.stopPropagation();
  if (!currentUser) return showMessage('로그인 먼저 해주세요');
  const reason = prompt('신고 사유를 입력하세요');
  if (!reason) return;

  fetch(`/posts/${postId}/report`, {
    method: 'POST',
    headers: {'Content-Type':'application/json'},
    body: JSON.stringify({user_id: currentUser.id, reason})
  }).then(res => res.json())
    .then(data => showMessage(data.message));
}
</script>

</body>
</html>
