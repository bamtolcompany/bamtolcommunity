<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<title>커뮤니티 앱</title>
<style>
  body { max-width: 600px; margin: auto; font-family: Arial, sans-serif; }
  input, textarea { width: 100%; margin-bottom: 8px; }
  button { margin: 4px 0; }
  .post, .comment { border: 1px solid #ddd; padding: 8px; margin-bottom: 8px; }
  .post img { max-width: 100%; }
  .hidden { display: none; }
</style>
</head>
<body>

<h1>커뮤니티 앱</h1>

<div id="auth">
  <h3>회원가입</h3>
  <input id="reg-username" placeholder="사용자 이름" />
  <input id="reg-password" placeholder="비밀번호" type="password" />
  <button onclick="register()">회원가입</button>

  <h3>로그인</h3>
  <input id="login-username" placeholder="사용자 이름" />
  <input id="login-password" placeholder="비밀번호" type="password" />
  <button onclick="login()">로그인</button>
</div>

<div id="app" class="hidden">
  <button onclick="logout()">로그아웃</button>
  <h3>글쓰기</h3>
  <textarea id="post-content" placeholder="내용"></textarea>
  <input type="file" id="post-image" />
  <button onclick="writePost()">글 작성</button>

  <h3>게시글 목록</h3>
  <div id="posts"></div>
</div>

<script>
let currentUser = null;

function showMessage(msg) {
  alert(msg);
}

function register() {
  fetch('/register', {
    method: 'POST',
    headers: {'Content-Type':'application/json'},
    body: JSON.stringify({
      username: document.getElementById('reg-username').value,
      password: document.getElementById('reg-password').value
    })
  }).then(res => res.json()).then(data => showMessage(data.message));
}

function login() {
  fetch('/login', {
    method: 'POST',
    headers: {'Content-Type':'application/json'},
    body: JSON.stringify({
      username: document.getElementById('login-username').value,
      password: document.getElementById('login-password').value
    })
  }).then(res => {
    if(res.status === 200) return res.json();
    else throw new Error('로그인 실패');
  }).then(data => {
    currentUser = { id: data.user_id, username: document.getElementById('login-username').value };
    document.getElementById('auth').classList.add('hidden');
    document.getElementById('app').classList.remove('hidden');
    loadPosts();
  }).catch(e => alert(e.message));
}

function logout() {
  currentUser = null;
  document.getElementById('auth').classList.remove('hidden');
  document.getElementById('app').classList.add('hidden');
}

function loadPosts() {
  fetch('/posts').then(res => res.json()).then(posts => {
    const postsDiv = document.getElementById('posts');
    postsDiv.innerHTML = '';
    posts.forEach(post => {
      const postDiv = document.createElement('div');
      postDiv.className = 'post';
      postDiv.innerHTML = `
        <b>${post.author}</b> - ${new Date(post.created).toLocaleString()}<br/>
        <p>${post.content}</p>
        ${post.image ? '<img src="/uploads/' + post.image + '" />' : ''}
        <button onclick="toggleLike(${post.id})">좋아요 (${post.likes})</button>
        <button onclick="showComments(${post.id})">댓글 보기</button>
        <div id="comments-${post.id}" class="hidden"></div>
        <textarea id="comment-text-${post.id}" placeholder="댓글 입력"></textarea>
        <button onclick="writeComment(${post.id})">댓글 작성</button>
        <button onclick="reportPost(${post.id})">신고</button>
      `;
      postsDiv.appendChild(postDiv);
    });
  });
}

function writePost() {
  if (!currentUser) return alert('로그인 먼저 해주세요');
  const content = document.getElementById('post-content').value;
  const imageFile = document.getElementById('post-image').files[0];

  const formData = new FormData();
  formData.append('user_id', currentUser.id);
  formData.append('content', content);
  if (imageFile) formData.append('image', imageFile);

  fetch('/posts', { method: 'POST', body: formData })
    .then(res => res.json())
    .then(data => {
      showMessage(data.message);
      document.getElementById('post-content').value = '';
      document.getElementById('post-image').value = '';
      loadPosts();
    });
}

function toggleLike(postId) {
  if (!currentUser) return alert('로그인 먼저 해주세요');
  fetch(`/posts/${postId}/like`, {
    method: 'POST',
    headers: {'Content-Type':'application/json'},
    body: JSON.stringify({user_id: currentUser.id})
  }).then(res => res.json())
    .then(data => {
      showMessage(data.message);
      loadPosts();
    });
}

function showComments(postId) {
  const commentsDiv = document.getElementById(`comments-${postId}`);
  if (commentsDiv.classList.contains('hidden')) {
    fetch(`/comments/${postId}`)
      .then(res => res.json())
      .then(comments => {
        commentsDiv.innerHTML = '';
        comments.forEach(c => {
          const cDiv = document.createElement('div');
          cDiv.className = 'comment';
          cDiv.innerHTML = `<b>${c.author}</b> - ${new Date(c.created).toLocaleString()}<br/>${c.text}`;
          commentsDiv.appendChild(cDiv);
        });
        commentsDiv.classList.remove('hidden');
      });
  } else {
    commentsDiv.classList.add('hidden');
  }
}

function writeComment(postId) {
  if (!currentUser) return alert('로그인 먼저 해주세요');
  const textArea = document.getElementById(`comment-text-${postId}`);
  const text = textArea.value;
  if (!text) return alert('댓글 내용을 입력하세요');

  fetch(`/comments/${postId}`, {
    method: 'POST',
    headers: {'Content-Type':'application/json'},
    body: JSON.stringify({user_id: currentUser.id, text: text})
  }).then(res => res.json())
    .then(data => {
      showMessage(data.message);
      textArea.value = '';
      showComments(postId);
    });
}

function reportPost(postId) {
  if (!currentUser) return alert('로그인 먼저 해주세요');
  const reason = prompt('신고 사유를 입력하세요');
  if (!reason) return;

  fetch(`/posts/${postId}/report`, {
    method: 'POST',
    headers: {'Content-Type':'application/json'},
    body: JSON.stringify({user_id: currentUser.id, reason: reason})
  }).then(res => res.json())
    .then(data => showMessage(data.message));
}
</script>

</body>
</html>
