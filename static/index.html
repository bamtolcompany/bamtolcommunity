<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>심플 커뮤니티</title>
<style>
  /* Reset */
  * {
    margin: 0; padding: 0; box-sizing: border-box;
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen,
      Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
  }
  html, body {
    height: 100%;
    background: #fff;
    color: #222;
  }
  body {
    display: flex;
    flex-direction: column;
    min-height: 100vh;
  }

  header {
    padding: 1rem 2rem;
    font-weight: 600;
    font-size: 1.5rem;
    border-bottom: 1px solid #ddd;
    background: #fafafa;
  }

  main {
    flex: 1;
    padding: 1rem 2rem;
    max-width: 900px;
    margin: 0 auto;
    width: 100%;
  }

  button {
    cursor: pointer;
    border: none;
    background: #222;
    color: white;
    font-weight: 600;
    padding: 0.5rem 1rem;
    border-radius: 0;
    transition: background 0.25s ease;
  }
  button:hover {
    background: #555;
  }

  input, textarea {
    border: 1px solid #ccc;
    padding: 0.5rem;
    width: 100%;
    font-size: 1rem;
    color: #222;
    resize: vertical;
  }

  input:focus, textarea:focus {
    outline: none;
    border-color: #666;
  }

  label {
    font-weight: 600;
    display: block;
    margin: 0.75rem 0 0.25rem;
  }

  .hidden {
    display: none;
  }

  /* 회원가입, 로그인 영역 */
  #auth-container {
    max-width: 400px;
    margin: 2rem auto;
  }
  #auth-container > * + * {
    margin-top: 1rem;
  }

  /* 게시글 리스트 */
  #posts-list {
    list-style: none;
    padding: 0;
  }
  #posts-list > li {
    border-bottom: 1px solid #eee;
    padding: 1rem 0;
  }
  #posts-list > li:last-child {
    border-bottom: none;
  }
  #posts-list .post-title {
    font-weight: 700;
    font-size: 1.2rem;
    margin-bottom: 0.25rem;
  }
  #posts-list .post-author {
    font-size: 0.9rem;
    color: #555;
    margin-bottom: 0.5rem;
  }
  #posts-list .post-content {
    white-space: pre-wrap;
    line-height: 1.3;
    margin-bottom: 0.5rem;
  }
  #posts-list img {
    max-width: 100%;
    height: auto;
    margin-top: 0.5rem;
  }

  /* 글 작성 폼 */
  #new-post-container {
    max-width: 700px;
    margin: 2rem auto;
    border-top: 1px solid #ddd;
    padding-top: 1rem;
  }

  /* 꽉찬 화면 */
  #app-container {
    min-height: 100vh;
    display: flex;
    flex-direction: column;
  }
  #content-area {
    flex: 1;
  }
</style>
</head>
<body>
  <header>밤톨 커뮤니티</header>

  <main id="content-area">
    <!-- 회원가입/로그인 -->
    <section id="auth-container">
      <div>
        <label for="username">아이디</label>
        <input type="text" id="username" autocomplete="username" />
      </div>
      <div>
        <label for="password">비밀번호</label>
        <input type="password" id="password" autocomplete="current-password" />
      </div>
      <div style="display:flex; gap: 1rem; margin-top:1rem;">
        <button id="btn-register">회원가입</button>
        <button id="btn-login">로그인</button>
      </div>
      <div id="auth-message" style="color: red; margin-top: 0.5rem;"></div>
    </section>

    <!-- 글 리스트 -->
    <section id="posts-container" class="hidden">
      <button id="btn-new-post" style="margin-bottom:1rem;">+ 새 글 작성</button>
      <ul id="posts-list"></ul>
    </section>

    <!-- 새 글 작성 폼 -->
    <section id="new-post-container" class="hidden">
      <label for="post-title">글 제목</label>
      <input type="text" id="post-title" maxlength="100" />
      <label for="post-content">글 내용</label>
      <textarea id="post-content" rows="6" maxlength="1000"></textarea>
      <label for="post-image">이미지 (선택)</label>
      <input type="file" id="post-image" accept="image/*" />
      <button id="btn-submit-post" style="margin-top:1rem;">작성 완료</button>
      <button id="btn-cancel-post" style="margin-top:1rem; background:#999;">취소</button>
      <div id="post-message" style="color: red; margin-top: 0.5rem;"></div>
    </section>
  </main>

<script>
  let userId = null;

  const authContainer = document.getElementById("auth-container");
  const postsContainer = document.getElementById("posts-container");
  const newPostContainer = document.getElementById("new-post-container");

  const authMessage = document.getElementById("auth-message");
  const postMessage = document.getElementById("post-message");

  const usernameInput = document.getElementById("username");
  const passwordInput = document.getElementById("password");

  const postTitleInput = document.getElementById("post-title");
  const postContentInput = document.getElementById("post-content");
  const postImageInput = document.getElementById("post-image");

  const postsList = document.getElementById("posts-list");

  document.getElementById("btn-register").onclick = async () => {
    authMessage.textContent = "";
    const username = usernameInput.value.trim();
    const password = passwordInput.value.trim();
    if (!username || !password) {
      authMessage.textContent = "아이디와 비밀번호를 모두 입력하세요.";
      return;
    }
    try {
      const res = await fetch("/register", {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify({username, password})
      });
      const data = await res.json();
      if(res.ok) {
        authMessage.style.color = "green";
        authMessage.textContent = "회원가입 완료. 로그인 해주세요.";
      } else {
        authMessage.style.color = "red";
        authMessage.textContent = data.message || "회원가입 실패";
      }
    } catch(e) {
      authMessage.style.color = "red";
      authMessage.textContent = "서버 에러";
    }
  };

  document.getElementById("btn-login").onclick = async () => {
    authMessage.textContent = "";
    const username = usernameInput.value.trim();
    const password = passwordInput.value.trim();
    if (!username || !password) {
      authMessage.textContent = "아이디와 비밀번호를 모두 입력하세요.";
      return;
    }
    try {
      const res = await fetch("/login", {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify({username, password})
      });
      const data = await res.json();
      if(res.ok) {
        userId = data.user_id;
        authContainer.classList.add("hidden");
        postsContainer.classList.remove("hidden");
        loadPosts();
      } else {
        authMessage.style.color = "red";
        authMessage.textContent = data.message || "로그인 실패";
      }
    } catch(e) {
      authMessage.style.color = "red";
      authMessage.textContent = "서버 에러";
    }
  };

  document.getElementById("btn-new-post").onclick = () => {
    postsContainer.classList.add("hidden");
    newPostContainer.classList.remove("hidden");
    postTitleInput.value = "";
    postContentInput.value = "";
    postImageInput.value = "";
    postMessage.textContent = "";
  };

  document.getElementById("btn-cancel-post").onclick = () => {
    newPostContainer.classList.add("hidden");
    postsContainer.classList.remove("hidden");
  };

  document.getElementById("btn-submit-post").onclick = async () => {
    postMessage.textContent = "";
    const title = postTitleInput.value.trim();
    const content = postContentInput.value.trim();
    if (!title || !content) {
      postMessage.textContent = "글 제목과 내용을 모두 입력하세요.";
      return;
    }
    const formData = new FormData();
    formData.append("user_id", userId);
    // 글 제목과 내용 분리 안된 서버 코드라서 제목은 내용 앞에 붙임 (제목 + 줄바꿈 + 내용)
    formData.append("content", title + "\n\n" + content);
    if(postImageInput.files.length > 0) {
      formData.append("image", postImageInput.files[0]);
    }
    try {
      const res = await fetch("/posts", {
        method: "POST",
        body: formData
      });
      const data = await res.json();
      if(res.ok) {
        newPostContainer.classList.add("hidden");
        postsContainer.classList.remove("hidden");
        loadPosts();
      } else {
        postMessage.textContent = data.message || "작성 실패";
      }
    } catch(e) {
      postMessage.textContent = "서버 에러";
    }
  };

  async function loadPosts() {
    postsList.innerHTML = "<li>불러오는 중...</li>";
    try {
      const res = await fetch("/posts");
      const posts = await res.json();
      if(Array.isArray(posts)) {
        if(posts.length === 0) {
          postsList.innerHTML = "<li>등록된 글이 없습니다.</li>";
          return;
        }
        postsList.innerHTML = "";
        for(const post of posts) {
          // 제목은 content의 첫 줄, 내용은 나머지
          let lines = post.content.split("\n");
          let title = lines.shift() || "";
          let content = lines.join("\n").trim();
          if(!content) content = "(내용 없음)";

          const li = document.createElement("li");
          li.innerHTML = `
            <div class="post-title">${escapeHtml(title)}</div>
            <div class="post-author">작성자: ${escapeHtml(post.author)} | 좋아요 ${post.likes} | ${new Date(post.created).toLocaleString()}</div>
            <div class="post-content">${escapeHtml(content).replace(/\n/g, "<br>")}</div>
            ${post.image ? `<img src="/uploads/${encodeURIComponent(post.image)}" alt="post image" />` : ""}
          `;
          postsList.appendChild(li);
        }
      } else {
        postsList.innerHTML = "<li>데이터 형식 오류</li>";
      }
    } catch(e) {
      postsList.innerHTML = "<li>서버 에러</li>";
    }
  }

  function escapeHtml(text) {
    return text.replace(/[&<>"']/g, m => {
      switch(m) {
        case "&": return "&amp;";
        case "<": return "&lt;";
        case ">": return "&gt;";
        case "\"": return "&quot;";
        case "'": return "&#39;";
        default: return m;
      }
    });
  }
</script>
</body>
</html>
